# Update.py å‡çº§è„šæœ¬å¡ä½é—®é¢˜åˆ†æä¸ä¿®å¤

## é—®é¢˜æè¿°

å‡çº§è„šæœ¬ `update.py` åœ¨æ‰§è¡Œæ—¶ä¼šå¡ä½ï¼Œç”¨æˆ·æ— æ³•çœ‹åˆ°è¿›åº¦ï¼Œä¸çŸ¥é“æ˜¯æ­£åœ¨è¿è¡Œè¿˜æ˜¯å·²ç»å¡æ­»ã€‚

## æ ¹æœ¬åŸå› åˆ†æ

### 1. **ç¼ºå°‘è¶…æ—¶æœºåˆ¶** â±ï¸

**é—®é¢˜ï¼š**
- åŸå§‹ä»£ç åœ¨æ‰§è¡Œ `subprocess.run()` æ—¶æ²¡æœ‰è®¾ç½® `timeout` å‚æ•°
- å¦‚æœç½‘ç»œæ…¢æˆ– npm ä»“åº“æ— å“åº”ï¼Œå‘½ä»¤ä¼šæ— é™æœŸç­‰å¾…
- ç”¨æˆ·æ— æ³•åˆ¤æ–­æ˜¯æ­£å¸¸è¿è¡Œè¿˜æ˜¯å·²ç»å¡æ­»

**å½±å“çš„å‘½ä»¤ï¼š**
```python
# npm --version
# npm list -g --json
# npm outdated -g --json
# npm install -g @anthropic-ai/claude-code  â† æœ€å®¹æ˜“å¡ä½
```

### 2. **ç¼ºå°‘å®æ—¶è¾“å‡º** ğŸ“º

**é—®é¢˜ï¼š**
- `npm install` å‘½ä»¤ä½¿ç”¨ `capture_output=True`ï¼Œæ‰€æœ‰è¾“å‡ºè¢«ç¼“å­˜
- å®‰è£…è¿‡ç¨‹å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿï¼Œä½†ç”¨æˆ·çœ‹ä¸åˆ°ä»»ä½•è¿›åº¦
- ç”¨æˆ·ä¼šè¯¯ä»¥ä¸ºç¨‹åºå¡ä½äº†

**åŸå§‹ä»£ç ï¼š**
```python
result = subprocess.run(
    cmd,
    env=env,
    cwd=cwd,
    capture_output=True,  # â† é—®é¢˜æ‰€åœ¨ï¼šéšè—äº†æ‰€æœ‰è¾“å‡º
    text=True,
    encoding='utf-8'
)
```

### 3. **ç¼ºå°‘è¿›åº¦æç¤º** ğŸ’¬

**é—®é¢˜ï¼š**
- åªæ˜¾ç¤º "â³ è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…..."
- ä¹‹åå°±æ²¡æœ‰ä»»ä½•è¾“å‡ºï¼Œç”¨æˆ·ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ
- æ²¡æœ‰æç¤ºç”¨æˆ·å¯ä»¥ä¸­æ–­æ“ä½œ

## ä¿®å¤æ–¹æ¡ˆ

### 1. âœ… æ·»åŠ è¶…æ—¶æœºåˆ¶

ä¸ºæ‰€æœ‰å‘½ä»¤æ·»åŠ åˆç†çš„è¶…æ—¶æ—¶é—´ï¼š

```python
def run_command(cmd: list, env: dict, cwd: Path = None, timeout: int = None, show_output: bool = False):
    try:
        result = subprocess.run(
            cmd,
            env=env,
            cwd=cwd,
            capture_output=True,
            text=True,
            encoding='utf-8',
            timeout=timeout  # â† æ–°å¢ï¼šè¶…æ—¶æ§åˆ¶
        )
        return result.returncode, result.stdout, result.stderr
    except subprocess.TimeoutExpired:
        return -1, "", "å‘½ä»¤æ‰§è¡Œè¶…æ—¶"
```

**è¶…æ—¶æ—¶é—´è®¾ç½®ï¼š**
- `npm --version`: 10ç§’
- `npm list -g --json`: 30ç§’
- `npm outdated -g --json`: 60ç§’ï¼ˆéœ€è¦è”ç½‘æŸ¥è¯¢ï¼‰
- `npm install -g`: 600ç§’ï¼ˆ10åˆ†é’Ÿï¼Œä¸‹è½½å’Œå®‰è£…éœ€è¦æ—¶é—´ï¼‰

### 2. âœ… æ·»åŠ å®æ—¶è¾“å‡ºåŠŸèƒ½

ä¸ºé•¿æ—¶é—´è¿è¡Œçš„å‘½ä»¤ï¼ˆå¦‚ npm installï¼‰æ·»åŠ å®æ—¶è¾“å‡ºï¼š

```python
def run_command(cmd: list, env: dict, cwd: Path = None, timeout: int = None, show_output: bool = False):
    if show_output:
        # å®æ—¶æ˜¾ç¤ºè¾“å‡º
        process = subprocess.Popen(
            cmd,
            env=env,
            cwd=cwd,
            stdout=subprocess.PIPE,
            stderr=subprocess.STDOUT,
            text=True,
            encoding='utf-8',
            bufsize=1,  # â† è¡Œç¼“å†²
            universal_newlines=True
        )
        
        output_lines = []
        for line in process.stdout:
            print(line, end='', flush=True)  # â† å®æ—¶æ‰“å°
            output_lines.append(line)
        
        process.wait(timeout=timeout)
        return process.returncode, ''.join(output_lines), ''
```

**ä½¿ç”¨æ–¹å¼ï¼š**
```python
returncode, stdout, stderr = run_command(
    ["npm", "install", "-g", package_name],
    env,
    timeout=600,
    show_output=True  # â† å¯ç”¨å®æ—¶è¾“å‡º
)
```

### 3. âœ… å¢å¼ºç”¨æˆ·æç¤º

æ·»åŠ æ›´å¤šçš„æç¤ºä¿¡æ¯ï¼š

```python
print(f"ğŸ“¦ æ­£åœ¨å‡çº§ {package_name}...")
print("â³ è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...")
print("ğŸ’¡ æç¤ºï¼šå¦‚æœé•¿æ—¶é—´æ— å“åº”ï¼Œå¯ä»¥æŒ‰ Ctrl+C ä¸­æ–­")  # â† æ–°å¢
print()
print("--- npm è¾“å‡º ---")  # â† æ–°å¢ï¼šæ ‡è®°è¾“å‡ºå¼€å§‹

# ... npm install æ‰§è¡Œ ...

print("--- npm è¾“å‡ºç»“æŸ ---")  # â† æ–°å¢ï¼šæ ‡è®°è¾“å‡ºç»“æŸ
```

### 4. âœ… æ”¹è¿›é”™è¯¯å¤„ç†

æ·»åŠ æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œå»ºè®®ï¼š

```python
if returncode != 0:
    print("âŒ å‡çº§å¤±è´¥")
    if stderr:
        print(f"é”™è¯¯ä¿¡æ¯: {stderr}")
    print("\nğŸ’¡ å¯èƒ½çš„åŸå› ï¼š")
    print("   1. ç½‘ç»œè¿æ¥é—®é¢˜")
    print("   2. npm ä»“åº“è®¿é—®å—é™")
    print("   3. æƒé™ä¸è¶³")
    print("\nğŸ’¡ å»ºè®®å°è¯•ï¼š")
    print("   1. æ£€æŸ¥ç½‘ç»œè¿æ¥")
    print("   2. ä½¿ç”¨ VPN æˆ–æ›´æ¢ç½‘ç»œ")
    print("   3. æ‰‹åŠ¨æ‰§è¡Œå‡çº§å‘½ä»¤")
    sys.exit(1)
```

## ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰ âŒ

```
ğŸ“¦ æ­£åœ¨å‡çº§ @anthropic-ai/claude-code...
â³ è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...

[é•¿æ—¶é—´æ— ä»»ä½•è¾“å‡ºï¼Œç”¨æˆ·ä¸çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ]
[å¯èƒ½çœŸçš„å¡ä½äº†ï¼Œä¹Ÿå¯èƒ½æ­£åœ¨ä¸‹è½½]
[ç”¨æˆ·åªèƒ½ç­‰å¾…æˆ–å¼ºåˆ¶ç»ˆæ­¢]
```

### ä¿®å¤å âœ…

```
ğŸ“¦ æ­£åœ¨å‡çº§ @anthropic-ai/claude-code...
â³ è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´ï¼Œè¯·è€å¿ƒç­‰å¾…...
ğŸ’¡ æç¤ºï¼šå¦‚æœé•¿æ—¶é—´æ— å“åº”ï¼Œå¯ä»¥æŒ‰ Ctrl+C ä¸­æ–­

--- npm è¾“å‡º ---
npm WARN deprecated ...
npm http fetch GET 200 https://registry.npmjs.org/@anthropic-ai/claude-code
npm http fetch GET 200 https://registry.npmjs.org/...
added 150 packages in 45s
--- npm è¾“å‡ºç»“æŸ ---

âœ… å‡çº§å®Œæˆ
```

## æŠ€æœ¯ç»†èŠ‚

### subprocess.run vs subprocess.Popen

**subprocess.runï¼ˆåŸæ–¹æ¡ˆï¼‰ï¼š**
- âœ… ç®€å•æ˜“ç”¨
- âŒ æ— æ³•å®æ—¶è·å–è¾“å‡º
- âŒ ç”¨æˆ·ä½“éªŒå·®

**subprocess.Popenï¼ˆæ–°æ–¹æ¡ˆï¼‰ï¼š**
- âœ… å¯ä»¥å®æ—¶è¯»å–è¾“å‡º
- âœ… ç”¨æˆ·å¯ä»¥çœ‹åˆ°è¿›åº¦
- âš ï¸ ä»£ç ç¨å¤æ‚

### ç¼“å†²åŒºè®¾ç½®

```python
bufsize=1,              # è¡Œç¼“å†²
universal_newlines=True # æ–‡æœ¬æ¨¡å¼
```

è¿™æ ·å¯ä»¥ç¡®ä¿æ¯ä¸€è¡Œè¾“å‡ºéƒ½ç«‹å³æ˜¾ç¤ºï¼Œè€Œä¸æ˜¯ç­‰åˆ°å‘½ä»¤ç»“æŸã€‚

### è¶…æ—¶å¤„ç†

```python
try:
    process.wait(timeout=timeout)
except subprocess.TimeoutExpired:
    process.kill()
    return -1, "", "å‘½ä»¤æ‰§è¡Œè¶…æ—¶"
```

å¦‚æœå‘½ä»¤è¶…æ—¶ï¼Œä¼šè‡ªåŠ¨ç»ˆæ­¢è¿›ç¨‹å¹¶è¿”å›é”™è¯¯ã€‚

## æµ‹è¯•å»ºè®®

### 1. æ­£å¸¸å‡çº§æµ‹è¯•

```bash
cd claude-code-venv
python update.py
```

**é¢„æœŸç»“æœï¼š**
- æ˜¾ç¤ºå½“å‰ç‰ˆæœ¬
- æ£€æŸ¥æ›´æ–°
- å®æ—¶æ˜¾ç¤º npm å®‰è£…è¾“å‡º
- æ˜¾ç¤ºå‡çº§ç»“æœ

### 2. ç½‘ç»œæ…¢æµ‹è¯•

æ¨¡æ‹Ÿç½‘ç»œæ…¢çš„æƒ…å†µï¼š
```bash
# é™åˆ¶ç½‘ç»œé€Ÿåº¦
# macOS: ä½¿ç”¨ Network Link Conditioner
# Windows: ä½¿ç”¨ NetLimiter
```

**é¢„æœŸç»“æœï¼š**
- èƒ½çœ‹åˆ° npm çš„ä¸‹è½½è¿›åº¦
- ä¸ä¼šè¯¯ä»¥ä¸ºå¡ä½
- å¦‚æœè¶…è¿‡10åˆ†é’Ÿä¼šè¶…æ—¶

### 3. ç½‘ç»œæ–­å¼€æµ‹è¯•

```bash
# æ–­å¼€ç½‘ç»œåæ‰§è¡Œ
python update.py
```

**é¢„æœŸç»“æœï¼š**
- åœ¨60ç§’å†…æ£€æµ‹åˆ°ç½‘ç»œé—®é¢˜
- æ˜¾ç¤ºè¶…æ—¶é”™è¯¯
- æä¾›è§£å†³å»ºè®®

### 4. ä¸­æ–­æµ‹è¯•

```bash
# æ‰§è¡ŒåæŒ‰ Ctrl+C
python update.py
```

**é¢„æœŸç»“æœï¼š**
- æ˜¾ç¤º "âŒ ç”¨æˆ·ä¸­æ–­æ“ä½œ"
- æ­£å¸¸é€€å‡ºï¼Œä¸ç•™åå°è¿›ç¨‹

## ç›¸å…³æ–‡ä»¶

- `update.py` - å‡çº§è„šæœ¬ï¼ˆå·²ä¿®å¤ï¼‰
- `UPDATE_README.md` - ä½¿ç”¨è¯´æ˜
- `run.py` - å¯åŠ¨è„šæœ¬

## ç‰ˆæœ¬å†å²

### v1.0.0 (åŸå§‹ç‰ˆæœ¬)
- âŒ æ— è¶…æ—¶æœºåˆ¶
- âŒ æ— å®æ—¶è¾“å‡º
- âŒ å®¹æ˜“å¡ä½

### v1.1.0 (ä¿®å¤ç‰ˆæœ¬ - 2026-02-10)
- âœ… æ·»åŠ è¶…æ—¶æœºåˆ¶
- âœ… æ·»åŠ å®æ—¶è¾“å‡º
- âœ… æ”¹è¿›ç”¨æˆ·æç¤º
- âœ… å¢å¼ºé”™è¯¯å¤„ç†

## æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

1. **è¶…æ—¶æ§åˆ¶**ï¼šé˜²æ­¢æ— é™ç­‰å¾…
2. **å®æ—¶è¾“å‡º**ï¼šè®©ç”¨æˆ·çœ‹åˆ°è¿›åº¦
3. **å‹å¥½æç¤º**ï¼šå‘ŠçŸ¥ç”¨æˆ·å¯ä»¥ä¸­æ–­
4. **é”™è¯¯å¤„ç†**ï¼šæä¾›è§£å†³å»ºè®®

### ç”¨æˆ·ä½“éªŒæå‡

- âœ… ä¸å†æ‹…å¿ƒç¨‹åºå¡ä½
- âœ… å¯ä»¥çœ‹åˆ°å®æ—¶è¿›åº¦
- âœ… çŸ¥é“ä½•æ—¶å¯ä»¥ä¸­æ–­
- âœ… é‡åˆ°é”™è¯¯æœ‰è§£å†³æ–¹æ¡ˆ

### æŠ€æœ¯äº®ç‚¹

- ä½¿ç”¨ `subprocess.Popen` å®ç°å®æ—¶è¾“å‡º
- åˆç†çš„è¶…æ—¶æ—¶é—´è®¾ç½®
- å®Œå–„çš„å¼‚å¸¸å¤„ç†
- æ¸…æ™°çš„ç”¨æˆ·åé¦ˆ

---

**æ–‡æ¡£ç‰ˆæœ¬ï¼š** 1.0  
**æœ€åæ›´æ–°ï¼š** 2026-02-10  
**ä¿®å¤äººå‘˜ï¼š** Claude (Cline)
