# Claude Code 升级工具使用说明

## 概述

`update.py` 是一个用于升级虚拟环境中 Claude Code 的自动化脚本。

## 功能特性

✨ **自动检测**
- 自动识别操作系统（Windows/macOS）
- 自动检测所有可用的虚拟环境（venv_win/venv_mac）
- 智能排序：当前系统对应的虚拟环境优先显示

🎯 **灵活选择**
- 交互式选择要升级的虚拟环境
- 支持单独升级某个虚拟环境
- 支持同时升级多个虚拟环境
- 可在 macOS 上升级 Windows 虚拟环境，反之亦然

🔍 **版本管理**
- 检查当前安装的版本
- 检测是否有可用更新
- 显示最新版本信息

🚀 **智能升级**
- 交互式确认升级操作
- 实时显示升级进度
- 自动验证升级结果

## 使用方法

### 基本用法

```bash
# 在 claude-code-venv 目录下执行
cd claude-code-venv
python update.py
```

或者从项目根目录执行：

```bash
python claude-code-venv/update.py
```

### 使用流程

1. **运行脚本**
   ```bash
   python update.py
   ```

2. **选择虚拟环境**
   - 脚本会显示所有可用的虚拟环境
   - 当前系统对应的虚拟环境会标记为"推荐"
   - 输入选项编号（直接回车选择推荐选项）
   - 可以选择单个虚拟环境或全部升级

3. **查看版本信息**
   - 脚本会自动检测当前安装的版本
   - 显示是否有可用更新

4. **确认升级**
   - 如果有更新，输入 `y` 或 `yes` 或 `是` 确认升级
   - 输入 `n` 或其他字符取消操作

5. **等待升级完成**
   - 升级过程可能需要几分钟
   - 可以看到实时的 npm 安装输出
   - 请耐心等待，不要中断

6. **查看升级结果**
   - 脚本会显示升级前后的版本对比
   - 自动测试 claude 命令是否可用
   - 显示成功和失败的统计

## 输出示例

### 示例 1：单个虚拟环境升级

```
======================================================================
🔄 Claude Code 虚拟环境升级工具
======================================================================
📍 脚本目录: /path/to/claude-code-venv
💻 当前系统: Darwin (macOS)
======================================================================

📦 检测到以下虚拟环境：
   1. macOS (venv_mac) ✨ (当前系统)
   2. Windows (venv_win)

请选择要升级的虚拟环境：
   1. macOS (推荐)
   2. Windows
   3. 全部升级

请输入选项编号 (直接回车选择推荐选项): 1

📦 将升级 macOS 虚拟环境
是否继续？(y/n): y

======================================================================
🔄 升级 macOS 虚拟环境
======================================================================
📦 虚拟环境: /path/to/claude-code-venv/venv_mac
======================================================================

🔍 检查 npm 是否可用...
✅ npm 版本: 10.2.4

🔍 检查当前 @anthropic-ai/claude-code 版本...
📦 当前版本: 2.1.30

🔍 检查是否有可用更新...
⏳ 正在连接 npm 仓库...
✨ 发现新版本: 2.1.31

======================================================================
🚀 开始升级...
======================================================================

📦 正在升级 @anthropic-ai/claude-code...
⏳ 这可能需要几分钟时间，请耐心等待...
💡 提示：如果长时间无响应，可以按 Ctrl+C 中断

--- npm 输出 ---
npm WARN deprecated ...
added 150 packages in 45s
--- npm 输出结束 ---

✅ 升级完成

🔍 验证升级结果...
📦 新版本: 2.1.31

======================================================================
✨ 升级总结
======================================================================
📦 包名称: @anthropic-ai/claude-code
📊 升级前: 2.1.30
📊 升级后: 2.1.31
======================================================================

🔍 测试 claude 命令...
✅ claude 命令可用: 2.1.31

======================================================================
🎉 升级流程完成！
======================================================================
✅ 成功: 1 个
======================================================================

💡 提示：
   - 使用 'python run.py' 启动 Claude Code
   - 使用 'python update.py' 再次升级
```

### 示例 2：跨平台升级（在 macOS 上升级 Windows 虚拟环境）

```
请选择要升级的虚拟环境：
   1. macOS (推荐)
   2. Windows
   3. 全部升级

请输入选项编号 (直接回车选择推荐选项): 2

📦 将升级 Windows 虚拟环境
是否继续？(y/n): y

======================================================================
🔄 升级 Windows 虚拟环境
======================================================================
📦 虚拟环境: /path/to/claude-code-venv/venv_win
======================================================================

[升级过程...]
```

### 示例 3：同时升级所有虚拟环境

```
请选择要升级的虚拟环境：
   1. macOS (推荐)
   2. Windows
   3. 全部升级

请输入选项编号 (直接回车选择推荐选项): 3

📦 将升级 2 个虚拟环境
是否继续？(y/n): y

[依次升级每个虚拟环境...]

======================================================================
🎉 升级流程完成！
======================================================================
✅ 成功: 2 个
======================================================================
```

## 常见问题

### Q: 可以在 macOS 上升级 Windows 虚拟环境吗？

**A:** 可以！脚本会检测所有可用的虚拟环境，你可以选择升级任何一个。npm 包是跨平台的，所以在 macOS 上升级 Windows 虚拟环境完全没问题。

### Q: 为什么要把当前系统作为第一个选项？

**A:** 这是为了方便快速操作。大多数情况下，你只需要升级当前系统使用的虚拟环境，所以：
- 当前系统的虚拟环境会标记为"推荐"
- 直接按回车就会选择推荐选项
- 节省输入时间

### Q: 升级失败怎么办？

**A:** 检查以下几点：
1. 确保网络连接正常
2. 确保 npm 已正确安装
3. 查看错误信息，根据提示解决
4. 尝试手动升级：
   ```bash
   cd claude-code-venv
   source venv_mac/bin/activate  # macOS
   # 或 venv_win\Scripts\activate  # Windows
   npm install -g @anthropic-ai/claude-code
   ```

### Q: 可以同时升级多个虚拟环境吗？

**A:** 可以！选择"全部升级"选项即可。脚本会依次升级每个虚拟环境，并在最后显示成功和失败的统计。

### Q: 如何查看当前版本？

**A:** 运行脚本会自动显示当前版本，或者手动查询：
```bash
cd claude-code-venv
python run.py --version
```

### Q: 可以降级到旧版本吗？

**A:** 可以，手动指定版本号：
```bash
cd claude-code-venv
source venv_mac/bin/activate  # macOS
npm install -g @anthropic-ai/claude-code@2.1.30
```

### Q: 升级会影响现有配置吗？

**A:** 不会。升级只更新程序文件，不会影响：
- `.env` 配置文件
- API 密钥
- 用户设置

### Q: 多久升级一次？

**A:** 建议：
- 每月检查一次更新
- 有重要功能更新时及时升级
- 遇到 bug 时查看是否有修复版本

## 技术细节

### 脚本功能

1. **平台检测**
   - 自动识别 Windows/macOS
   - 检测所有可用的虚拟环境目录
   - 智能排序：当前系统优先

2. **交互选择**
   - 显示所有可用的虚拟环境
   - 支持单选或全选
   - 直接回车选择推荐选项

3. **环境配置**
   - 设置 `VIRTUAL_ENV` 环境变量
   - 设置 `NPM_CONFIG_PREFIX` 指向虚拟环境
   - 更新 `PATH` 环境变量

4. **版本检查**
   - 使用 `npm list -g --json` 获取当前版本
   - 使用 `npm outdated -g --json` 检查更新

5. **升级执行**
   - 使用 `npm install -g` 安装最新版本
   - 实时显示 npm 输出
   - 支持超时控制

6. **结果验证**
   - 再次查询版本确认升级成功
   - 测试 `claude --version` 命令
   - 统计成功和失败数量

### 依赖要求

- Python 3.6+
- npm（已安装在系统中）
- 虚拟环境（venv_mac 或 venv_win）

## 相关文件

- `update.py` - 升级脚本
- `run.py` - 启动脚本
- `VERSION` - 版本记录文件
- `.env` - 环境配置文件
- `UPDATE_ISSUE_ANALYSIS.md` - 问题分析文档

## 维护建议

1. **定期检查更新**
   ```bash
   python update.py
   ```

2. **备份重要配置**
   - 升级前备份 `.env` 文件
   - 记录当前版本号

3. **测试升级结果**
   - 升级后运行 `python run.py` 测试
   - 确认所有功能正常

## 故障排除

### 错误：虚拟环境不存在

```
❌ 错误：没有找到任何虚拟环境
```

**解决方案：**
- 确保在正确的目录下运行脚本
- 检查虚拟环境是否已创建

### 错误：npm 不可用

```
❌ 错误：npm 不可用
```

**解决方案：**
- 安装 Node.js 和 npm
- 确保 npm 在系统 PATH 中

### 错误：权限不足

**解决方案：**
```bash
chmod +x update.py
```

## 更新日志

### v1.0.0 (2026-02-09)
- ✨ 初始版本发布
- 🔍 支持版本检查
- 🚀 支持自动升级
- 💻 支持 Windows/macOS 双平台
- ✅ 支持升级结果验证

### v1.1.0 (2026-02-10)
- ✅ 添加超时机制
- ✅ 添加实时输出
- ✅ 改进用户提示
- ✅ 增强错误处理

### v1.2.0 (2026-02-10)
- ✅ 支持交互式选择虚拟环境
- ✅ 支持跨平台升级（macOS 可升级 Windows 虚拟环境）
- ✅ 支持同时升级多个虚拟环境
- ✅ 智能排序：当前系统优先
- ✅ 直接回车选择推荐选项

---

**提示：** 如有问题或建议，请查看项目文档或联系维护者。
